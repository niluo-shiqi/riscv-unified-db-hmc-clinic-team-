# This file was generated by `./bin/chore gen regress`
# DO NOT EDIT
# Instead, edit `tools/test/regress-tests.yaml` (preferred) or `tools/test/regress-gh-template.yaml`

---
name: CI/CD
permissions:
  contents: read
  pull-requests: write
  packages: read
'on':
  pull_request:
    branches:
    - main
  merge_group:
    types:
    - checks_requested
  workflow_dispatch:
  push:
    branches:
    - main
env:
  DOCKER: 1
  DEPLOY_DIR: _site
concurrency:
  group: "${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
  cancel-in-progress: true
jobs:
  build-container:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Get container tag
      run: |
        TAG=$(cat bin/.container-tag)
        echo "TAG=$TAG" >> $GITHUB_ENV
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772
      with:
        registry: ghcr.io
        username: "${{ github.actor }}"
        password: "${{ secrets.GITHUB_TOKEN }}"
    - name: Check if container image exists in registry
      id: check-registry
      run: |
        if docker manifest inspect ghcr.io/riscv/udb:${{ env.TAG }} > /dev/null 2>&1; then
          echo "REGISTRY_HIT=true" >> $GITHUB_ENV
        else
          echo "REGISTRY_HIT=false" >> $GITHUB_ENV
        fi
    - name: Pull image from registry
      if: env.REGISTRY_HIT == 'true'
      run: |
        docker pull ghcr.io/riscv/udb:${{ env.TAG }}
        docker save ghcr.io/riscv/udb:${{ env.TAG }} -o ${{ runner.temp }}/docker_image.tar
    - name: Set up Docker Buildx
      if: env.REGISTRY_HIT == 'false'
      uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f
    - name: Build and export
      if: env.REGISTRY_HIT == 'false'
      uses: docker/build-push-action@601a80b39c9405e50806ae38af30926f9d957c47
      with:
        push: false
        file: "./.devcontainer/Dockerfile"
        platforms: linux/amd64
        tags: ghcr.io/riscv/udb:${{ env.TAG }}
        outputs: type=docker,dest=${{ runner.temp }}/docker_image.tar
        cache-from: type=gha
        cache-to: type=gha,mode=max
    - name: Upload container
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
      with:
        name: docker_image
        path: "${{ runner.temp }}/docker_image.tar"
  never-runs:
    runs-on: ubuntu-latest
    if: 'false'
    steps:
    - name: Use download-artifact
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
    - name: Use upload-artifact
      uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5
      with:
        path: "."
  regress-pre-commit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      with:
        submodules: 'true'
    - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
    - uses: pre-commit/action@2c7b3805fd2a0fd8c1884dcaebf91fc102a13ecd
  regress-llvm:
    runs-on: ubuntu-latest
    needs:
    - build-container
    - build-llvm
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Get current LLVM submodule commit SHA
      id: get-llvm-sha
      run: echo "LLVM_SHA=$(git ls-tree HEAD ext/llvm-project | awk '{print $3}')" >> $GITHUB_ENV
    - name: Restore cache RISC-V JSON
      id: cache-riscv
      uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
      with:
        path: ext/llvm-project/riscv.json
        key: "${{ runner.os }}-riscv-json-${{ env.LLVM_SHA }}"
    - name: Test LLVM
      run: "./do test:llvm"
  regress-find-configs:
    runs-on: ubuntu-latest
    needs: build-container
    outputs:
      configs: "${{ steps.configs.outputs.configs }}"
    steps:
    - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
    - name: Find configuration files
      id: configs
      run: 'ruby -e "puts ''configs=[\"'' + Dir.glob(''cfgs/*.yaml'').map { |f| File.basename(f, ''.yaml'') }.join(''\", \"'') + ''\"]''" >> "$GITHUB_OUTPUT"

        '
  regress-udb-cov-report:
    runs-on: ubuntu-latest
    needs:
    - build-container
    - regress-udb-unit-test
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: download coverage
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        pattern: udb-*-cov
        path: _cov/udb
        merge-multiple: true
        github-token: "${{ secrets.GITHUB_TOKEN }}"
    - name: Collate coverage
      run: "./do chore:udb:collate_cov[_cov/udb]"
    - name: Upload udb coverage reports to Codecov
      uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de
      with:
        token: "${{ secrets.CODECOV_TOKEN }}"
        disable_search: true
        files: tools/ruby-gems/udb/coverage/coverage.xml
        flags: udb
  build-llvm:
    runs-on: ubuntu-latest
    steps:
    - name: Check out repository (no submodules, shallow fetch)
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      with:
        submodules: false
        fetch-depth: 1
    - name: Get current LLVM submodule commit SHA
      id: get-llvm-sha
      run: echo "LLVM_SHA=$(git ls-tree HEAD ext/llvm-project | awk '{print $3}')" >> $GITHUB_ENV
    - name: Cache RISC-V JSON
      id: cache-riscv
      uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
      with:
        path: ext/llvm-project/riscv.json
        key: "${{ runner.os }}-riscv-json-${{ env.LLVM_SHA }}"
    - name: Initialize LLVM submodule (shallow + sparse)
      if: "${{ steps.cache-riscv.outputs.cache-hit != 'true' }}"
      run: |
        rm -rf ext/llvm-project
        git submodule sync --recursive
        git submodule update --init --recursive --depth=1 ext/llvm-project
    - name: Check for required directories and files
      if: "${{ steps.cache-riscv.outputs.cache-hit != 'true' }}"
      run: |
        ls -l ext/llvm-project/llvm/include
        ls -l ext/llvm-project/llvm/lib/Target/RISCV
        ls -l ext/llvm-project/llvm/lib/Target/RISCV/RISCV.td
    - name: Configure and build llvm-tblgen
      if: "${{ steps.cache-riscv.outputs.cache-hit != 'true' }}"
      run: |
        cmake -S ext/llvm-project/llvm -B ext/llvm-project/build -DCMAKE_BUILD_TYPE=Release
        cmake --build ext/llvm-project/build --target llvm-tblgen
    - name: Generate RISC-V JSON
      if: "${{ steps.cache-riscv.outputs.cache-hit != 'true' }}"
      run: |
        chmod +x ./ext/llvm-project/build/bin/llvm-tblgen
        ./ext/llvm-project/build/bin/llvm-tblgen \
          -I ext/llvm-project/llvm/include \
          -I ext/llvm-project/llvm/lib/Target/RISCV \
          ext/llvm-project/llvm/lib/Target/RISCV/RISCV.td \
          --dump-json \
          -o ext/llvm-project/riscv.json
    - name: Show riscv.json output
      run: ls -l ext/llvm-project/riscv.json
    - name: Upload RISC-V JSON as Artifact
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
      with:
        name: riscv-json
        path: ext/llvm-project/riscv.json
  java-tests:
    name: Java (Xtext) tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: tools/eclipse/dev/org.xtext.udb.parent
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
    - name: Setup Temurin JDK 21
      uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654
      with:
        distribution: temurin
        java-version: '21'
        cache: maven
    - name: Build & test (whole reactor)
      working-directory: tools/eclipse/dev/org.xtext.udb.parent
      env:
        MAVEN_OPTS: "-Djdk.xml.maxGeneralEntitySizeLimit=0 -Djdk.xml.totalEntitySizeLimit=0 -Djdk.xml.entityExpansionLimit=0"
      run: mvn -B -U -Dheadless=true verify
    - name: Archive surefire reports (always)
      if: always()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
      with:
        name: surefire-reports
        path: |
          **/target/surefire-reports/*.xml
          **/target/surefire-reports/*.txt
  vscode-tests:
    name: VS Code Mocha tests
    runs-on: ubuntu-latest
    needs: java-tests
    defaults:
      run:
        working-directory: tools/eclipse/udb-vscode
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
    - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
      with:
        node-version: '20'
        cache: npm
        cache-dependency-path: tools/eclipse/udb-vscode/package-lock.json
    - name: Setup Temurin JDK 21 (for LS)
      uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654
      with:
        distribution: temurin
        java-version: '21'
    - name: Install deps
      run: npm ci
    - name: Compile
      run: npm run compile
    - name: Run VS Code tests
      run: xvfb-run -a npm test
    - name: Archive VS Code test logs (always)
      if: always()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
      with:
        name: vscode-test-logs
        path: |
          tools/eclipse/udb-vscode/.vscode-test/**/*
          tools/eclipse/udb-vscode/out/test/**/*
  regress-idlc-unit:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Run idlc unit tests
      run: "./do test:idlc:unit"
    - name: Upload idlc coverage reports to Codecov
      uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de
      with:
        token: "${{ secrets.CODECOV_TOKEN }}"
        disable_search: true
        files: tools/ruby-gems/idlc/coverage/coverage.xml
        flags: idlc
  regress-udb-helpers-unit:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Run udb-helpers unit tests
      run: "./do test:udb_helpers:unit"
  regress-sorbet:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Run sorbet checks
      run: export XDG_CACHE_HOME=${{ github.workspace }}/.cache && ./do test:sorbet
  regress-ext-explorer:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Generate ISA Explorer browser artifacts
      run: "./bin/udb-gen isa-explorer -t ext-browser -o gen/isa_explorer --skip 6"
  regress-idl-typecheck:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Type check IDL for _
      run: "./do test:idl CFG=_"
    - name: Type check IDL for rv32
      run: "./do test:idl CFG=rv32"
    - name: Type check IDL for rv64
      run: "./do test:idl CFG=rv64"
    - name: Type check IDL for qc_iu
      run: "./do test:idl CFG=qc_iu"
  regress-test-inst-encodings:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Checking for conflicts in instruction encodings
      run: "./do test:inst_encodings"
  regress-gen-isa-manual:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: checkout ISA manual
      run: git submodule update --init ext/riscv-isa-manual
    - name: Mark isa-manual as safe
      run: ./bin/bash -c "git config --local --add safe.directory '*'"
    - name: Generate HTML ISA manual
      run: "./bin/generate manual -c regress -v isa_regress -f html"
  regress-gen-instruction-appendix:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Generate instruction appendix asciidoc
      run: "./do gen:instruction_appendix_adoc"
    - name: Check instruction appendix result
      run: "./do test:instruction_appendix"
  regress-cfg-manual:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Generate HTML ISA manual
      run: "./do gen:html[example_rv64_with_overlay]"
  regress-gen-ext-pdf:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Generate Xqci extension PDF
      run: "./bin/ruby tools/scripts/gen_xqci.rb"
  regress-gen-certificate:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Generate extension PDF
      run: "./do gen:proc_crd_pdf[MockProcessor]"
  regress-gen-profile:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Generate extension PDF
      run: "./do gen:profile_release_pdf[Mock]"
  regress-udb-unit-test:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Run udb gem ${{ matrix.test }} unit tests
      run: "./bin/ruby tools/ruby-gems/udb/test/test_${{ matrix.test }}.rb"
    - name: Update ownership of coverage files
      run: sudo chown -R $USER:$USER tools/ruby-gems/udb/coverage
    - name: Rename coverage file
      run: mv tools/ruby-gems/udb/coverage/.resultset.json tools/ruby-gems/udb/coverage/${{ matrix.test }}.resultset.json
    - name: Save coverage report
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
      with:
        name: udb-${{ matrix.test }}-cov
        path: tools/ruby-gems/udb/coverage/${{ matrix.test }}.resultset.json
    strategy:
      matrix:
        test:
        - logic
        - conditions
        - cli
        - yaml_loader
        - cfg_arch
        - cfg
        - mmr
        - mmr_schema
  regress-gen-go:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Generate Go code
      run: "./do gen:go"
  regress-gen-c-header:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Generate c_header code
      run: "./do gen:c_header"
  regress-gen-sverilog:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Generate sverilog_header code
      run: "./do gen:sverilog"
  regress-cpp-unit:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Run cpp unit tests
      run: "./do test:cpp_hart CONFIG=rv64 JOBS=4 BUILD_TYPE=debug"
  regress-riscv-tests-32:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: check out riscv-tests
      run: git submodule update --init ext/riscv-tests
    - name: Run RV32 riscv-tests
      run: "./do test:riscv_tests CONFIG=rv32 IGNOREUNDEFINED=YES JOBS=4 BUILD_TYPE=debug"
  regress-riscv-tests-64:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: check out riscv-tests
      run: git submodule update --init ext/riscv-tests
    - name: Run RV64 riscv-tests
      run: "./do test:riscv_tests CONFIG=rv64 IGNOREUNDEFINED=YES JOBS=4 BUILD_TYPE=debug"
  regress-xqci-doc:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Generate Xqci pdf documentation
      run: "./bin/ruby tools/scripts/gen_xqci.rb"
  regress-profile-extensions:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Check profile_extensions
      run: "./do test:profile_extensions"
  regress-regress:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Test that local regress runner works
      run: "./bin/regress -n regress-sorbet"
  build-reuse-manifest:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Create reuse manifest
      run: "./bin/reuse spdx -o reuse_bom.txt"
    - name: Upload artifact
      uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5
      if: "((github.event_name == 'push') && (github.ref_name == 'main'))"
      with:
        name: reuse-manifest
        path: reuse_bom.txt
    if: "(github.event_name == 'merge_queue') || ((github.event_name == 'push') && (github.ref_name == 'main'))"
  build-udb-api-docs:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Generate UDB API Docs
      run: "./do gen:udb:api_doc"
    - name: Upload artifact
      uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5
      if: "((github.event_name == 'push') && (github.ref_name == 'main'))"
      with:
        name: udb-api
        path: gen/udb_api_doc
        include-hidden-files: true
    if: "(github.event_name == 'merge_queue') || ((github.event_name == 'push') && (github.ref_name == 'main'))"
  resolve-unconfig:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Resolve Unconfig with IDL AST
      run: "./do gen:resolved_arch COMPILE_IDL=1"
    - name: Tar unconfig
      run: tar czf gen/resolved_spec/_resolved_spec.tar.gz gen/resolved_spec/_ && mv gen/resolved_spec/_resolved_spec.tar.gz gen/resolved_spec/_/resolved_spec.tar.gz
    - name: Upload artifact
      uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5
      if: "((github.event_name == 'push') && (github.ref_name == 'main'))"
      with:
        name: resolved-spec
        path: gen/resolved_spec/_
        include-hidden-files: true
    if: "(github.event_name == 'merge_queue') || ((github.event_name == 'push') && (github.ref_name == 'main'))"
  build-isa-explorer-csr:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Generate ISA Explorer CSR
      run: "./bin/udb-gen isa-explorer -t csr-browser -o gen/isa_explorer/browser"
    - name: Upload artifact
      uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5
      if: "((github.event_name == 'push') && (github.ref_name == 'main'))"
      with:
        name: isa-explorer-csr
        path: gen/isa_explorer/browser
    if: "(github.event_name == 'merge_queue') || ((github.event_name == 'push') && (github.ref_name == 'main'))"
  build-isa-explorer-ext:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Generate ISA Explorer Extension
      run: "./bin/udb-gen isa-explorer -t ext-browser -o gen/isa_explorer/browser"
    - name: Upload artifact
      uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5
      if: "((github.event_name == 'push') && (github.ref_name == 'main'))"
      with:
        name: isa-explorer-ext
        path: gen/isa_explorer/browser
    if: "(github.event_name == 'merge_queue') || ((github.event_name == 'push') && (github.ref_name == 'main'))"
  build-isa-explorer-inst:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Generate ISA Explorer Instruction
      run: "./bin/udb-gen isa-explorer -t inst-browser -o gen/isa_explorer/browser"
    - name: Upload artifact
      uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5
      if: "((github.event_name == 'push') && (github.ref_name == 'main'))"
      with:
        name: isa-explorer-inst
        path: gen/isa_explorer/browser
    if: "(github.event_name == 'merge_queue') || ((github.event_name == 'push') && (github.ref_name == 'main'))"
  build-isa-explorer-spreadsheet:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Generate ISA Explorer Spreadsheet
      run: "./bin/udb-gen isa-explorer -t xlsx -o gen/isa_explorer/spreadsheet"
    - name: Upload artifact
      uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5
      if: "((github.event_name == 'push') && (github.ref_name == 'main'))"
      with:
        name: isa-explorer-spreadsheet
        path: gen/isa_explorer/spreadsheet
    if: "(github.event_name == 'merge_queue') || ((github.event_name == 'push') && (github.ref_name == 'main'))"
  build-html-isa-manual:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Generate HTML ISA manual
      run: "./bin/generate manual -v all -f html"
    - name: Upload artifact
      uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5
      if: "((github.event_name == 'push') && (github.ref_name == 'main'))"
      with:
        name: isa-html-manual
        path: gen/manual/isa/top/all/html
    if: "(github.event_name == 'merge_queue') || ((github.event_name == 'push') && (github.ref_name == 'main'))"
  build-html-cfg-isa-manual:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Generate HTML ISA manual for a config
      run: "./do gen:html[example_rv64_with_overlay]"
    - name: Upload artifact
      uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5
      if: "((github.event_name == 'push') && (github.ref_name == 'main'))"
      with:
        name: cfg-html-manual
        path: gen/cfg_html_doc/example_rv64_with_overlay/html
    if: "(github.event_name == 'merge_queue') || ((github.event_name == 'push') && (github.ref_name == 'main'))"
  build-instruction-appendix:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: checkout docs resources
      run: git submodule update --init ext/docs-resources
    - name: Generate instruction appendix
      run: "./do gen:instruction_appendix"
    - name: Upload artifact
      uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5
      if: "((github.event_name == 'push') && (github.ref_name == 'main'))"
      with:
        name: inst-appendix
        path: gen/instructions_appendix/instructions_appendix.pdf
    if: "(github.event_name == 'merge_queue') || ((github.event_name == 'push') && (github.ref_name == 'main'))"
  build-profile:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Generate ${{ matrix.profile }}
      run: |
        PROFILE_NAME="${{ matrix.profile }}"
        UPPER_PROFILE="${PROFILE_NAME^^}"
        ./do gen:profile_release_pdf[${PROFILE_NAME}]
    - name: Upload artifact
      uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5
      if: "((github.event_name == 'push') && (github.ref_name == 'main'))"
      with:
        name: "${{ matrix.profile }}"
        path: gen/profile/pdf/RVA20ProfileRelease.pdf
    if: "(github.event_name == 'merge_queue') || ((github.event_name == 'push') && (github.ref_name == 'main'))"
    strategy:
      matrix:
        profile:
        - rvi20
        - rva20
        - rva22
        - rva23
        - rvb23
  build-idl-doc:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
    - name: Clone Github Repo Action
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
    - name: Download docker image
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        name: docker_image
        path: "${{ runner.temp }}"
    - name: Load image
      run: docker load --input ${{ runner.temp }}/docker_image.tar
    - name: Build IDL doc
      run: "./bin/bundle exec asciidoctor -r idl_highlighter -a toc=left -a source-highlighter=rouge -o idl.html doc/idl.adoc"
    - name: Upload artifact
      uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5
      if: "((github.event_name == 'push') && (github.ref_name == 'main'))"
      with:
        name: idl-doc
        path: idl.html
    if: "(github.event_name == 'merge_queue') || ((github.event_name == 'push') && (github.ref_name == 'main'))"
  regress-complete:
    runs-on: ubuntu-latest
    needs:
    - regress-idlc-unit
    - regress-udb-helpers-unit
    - regress-sorbet
    - regress-ext-explorer
    - regress-idl-typecheck
    - regress-test-inst-encodings
    - regress-gen-isa-manual
    - regress-gen-instruction-appendix
    - regress-cfg-manual
    - regress-gen-ext-pdf
    - regress-gen-certificate
    - regress-gen-profile
    - regress-udb-unit-test
    - regress-gen-go
    - regress-gen-c-header
    - regress-gen-sverilog
    - regress-cpp-unit
    - regress-riscv-tests-32
    - regress-riscv-tests-64
    - regress-xqci-doc
    - regress-profile-extensions
    - regress-regress
    - build-reuse-manifest
    - build-udb-api-docs
    - resolve-unconfig
    - build-isa-explorer-csr
    - build-isa-explorer-ext
    - build-isa-explorer-inst
    - build-isa-explorer-spreadsheet
    - build-html-isa-manual
    - build-html-cfg-isa-manual
    - build-instruction-appendix
    - build-profile
    - build-idl-doc
    - regress-pre-commit
    - regress-llvm
    - regress-find-configs
    - regress-udb-cov-report
    - build-llvm
    - java-tests
    - vscode-tests
    if: "${{ always() }}"
    steps:
    - name: exit failure
      if: "${{ contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') }}"
      run: exit 1
    - name: exit success
      if: "${{ !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled') }}"
      run: exit 0
