/*
 * generated by Xtext 2.39.0
 */
package org.xtext.example.udb.tests

import com.google.inject.Inject
import org.eclipse.xtext.testing.InjectWith
import org.eclipse.xtext.testing.extensions.InjectionExtension
import org.eclipse.xtext.testing.util.ParseHelper
import org.junit.jupiter.api.Assertions
import org.junit.jupiter.api.Test
import org.junit.jupiter.api.^extension.ExtendWith
import org.xtext.example.udb.udb.Model

@ExtendWith(InjectionExtension)
@InjectWith(UdbInjectorProvider)
class UdbParsingTest {
	@Inject
	ParseHelper<Model> parseHelper

	@Test
	def void parsesValidCSR() {
		val result = parseHelper.parse('''
			$schema: "csr_schema.json#"
			kind: csr
			name: vcsr
			long_name: Vector Control and Status Register
			address: 0x00F
			writable: true
			priv_mode: U
			length: MXLEN
			description: "Contains aliases to vxrm and vxsat CSRs"
			definedBy: "V"
			fields:
				VXRM:
					location: 2-1
					description: "See vxrm."
					type: RW-RH
					alias: vxrm.VALUE[1:0]
					sw_write(csr_value): "|
					  CSR[vxrm].VALUE = csr_value.VXRM;
					  return csr_value.VXRM;"
					reset_value: UNDEFINED_LEGAL
				VXSAT:
					location: 0
					description: "See vxsat."
					type: RW-RH
					alias: vxsat.VALUE[0]
					sw_write(csr_value): "|
					  CSR[vxsat].VALUE = csr_value.VXSAT;
					  return csr_value.VXSAT;"
					reset_value: UNDEFINED_LEGAL
		''')
		Assertions.assertNotNull(result)
		val errors = result.eResource.errors
		Assertions.assertTrue(errors.isEmpty, '''Unexpected errors: «errors.join(", ")»''')


		// check basic inputs
		var csr = result.getCsr();
		
		var schema = csr.getSchema().getSchema();
		Assertions.assertEquals("csr_schema.json#", schema as String);
		var k = csr.getCsrKind().getKind();
		Assertions.assertEquals("csr", k as String);
		var n = csr.getCsrName().getName();
		Assertions.assertEquals("vcsr", n as String);
		var ln = String.join(" ", csr.getLongName().getLongName().getWords());
		Assertions.assertEquals("Vector Control and Status Register", ln);
		var add = csr.getAddress().getAddress().getValue();
		Assertions.assertEquals(0x00F, add);
		var writ = csr.getWritable().isWritable();
		Assertions.assertTrue(writ);
		var priv = csr.getPrivmode().getPrivMode();
		Assertions.assertEquals("U", priv);
		var len = csr.getLength().getLength().getParmType().getParmName();
		Assertions.assertEquals("MXLEN", len as String);
		var desc = csr.getDescription().getDescription();
		Assertions.assertEquals("Contains aliases to vxrm and vxsat CSRs", desc);
		var def = csr.getDefinedBy().getExtensionName();
		Assertions.assertEquals("V", def);

		// test fields
		var vxrm = csr.getCsrFields().getFields.get(0);
		var vxsat = csr.getCsrFields().getFields().get(1);
		Assertions.assertEquals("VXRM", vxrm.getName());
		Assertions.assertEquals("VXSAT", vxsat.getName());

		// test location
		var rmrange = vxrm.getLocation().getStaticLoc().getLocValue().getRange();
		var satloc = vxsat.getLocation().getStaticLoc().getLocValue().getValue();
		Assertions.assertEquals(2, rmrange.getUpper());
		Assertions.assertEquals(1, rmrange.getLower());
		Assertions.assertEquals(0, satloc);

		// test reset value
		var rmreset = vxrm.getResetValue().getValue().getResetValue().getUndefinedLegal();
		var satreset = vxsat.getResetValue().getValue().getResetValue().getUndefinedLegal();
		Assertions.assertEquals("UNDEFINED_LEGAL", rmreset as String);
		Assertions.assertEquals("UNDEFINED_LEGAL", satreset as String);

		// test IDL
		var rmsw = vxrm.getSwWriteFunc().getSwWriteFunc().getIdl();
		var satsw = vxsat.getSwWriteFunc().getSwWriteFunc().getIdl();
		Assertions.assertNotNull(rmsw)
		Assertions.assertNotNull(satsw)

		// testing description of fields
		var rmdesc = vxrm.getDescription().getDescription();
		var satdesc = vxsat.getDescription().getDescription();
		Assertions.assertEquals("See vxrm.", rmdesc);
		Assertions.assertEquals("See vxsat.", satdesc);

		// testing field type
		var rmtype = vxrm.getType().getTypeVal().getPerms();
		var sattype = vxsat.getType().getTypeVal().getPerms();
		Assertions.assertEquals("RW-RH", rmtype);
		Assertions.assertEquals("RW-RH", sattype);

		// testing alias
		var vxalias = String.join("", vxrm.getAlias().getAliasName().getName().getWords());
		var satalias = String.join("", vxsat.getAlias().getAliasName().getName().getWords());
		Assertions.assertEquals("vxrm.VALUE[1:0]", vxalias);
		Assertions.assertEquals("vxsat.VALUE[0]", satalias);


	}
	
	@Test
	def void parsesValidExtension() {
		val result = parseHelper.parse('''
		$schema: "ext_schema.json#"
		kind: extension
		name: V
		type: unprivileged
		long_name: Vector Operations
		versions:
		  - version: "1.0.0"
		    state: ratified
		    ratification_date: 2021-11
		description: "|
		  General support for data-parallel execution."
		requirements: '
		  extension:
		    allOf:
		      - name: Zve64d
		      - name: Zvl128b'
		''')
		Assertions.assertNotNull(result)
		val errors = result.eResource.errors
		Assertions.assertTrue(errors.isEmpty, '''Unexpected errors: «errors.join(", ")»''')
		
		var ext = result.getExt();
		
		var schema = ext.getSchema().getSchema();
		Assertions.assertEquals("ext_schema.json#", schema as String);
		var kind = ext.getExtKind().getKind();
		Assertions.assertEquals("extension", kind);
		var name = ext.getExtName().getName();
		Assertions.assertEquals("V", name);
		var type = ext.getType().getPerms();
		Assertions.assertEquals("unprivileged", type);
		var longname = String.join(" ", ext.getLongName().getLongName().getWords());
		Assertions.assertEquals("Vector Operations", longname);
		var description = ext.getDescription().getDescription();
		Assertions.assertEquals("|\n  General support for data-parallel execution.", description);
		
		// version testing
		var version = ext.getExtVersions().getElements().get(0);
		Assertions.assertEquals("1.0.0", version.getVersion());
		Assertions.assertEquals("ratified", version.getVersionState().getState());
		Assertions.assertEquals("2021-11", version.getRatificationDate().getDate());
		
		// requirements testing
		var reqs = ext.getRequirements();
		System.out.println(reqs.getRequirements());
		
		
		
	}
	
	

}
