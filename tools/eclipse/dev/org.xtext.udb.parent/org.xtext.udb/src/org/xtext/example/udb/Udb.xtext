grammar org.xtext.example.udb.Udb with org.eclipse.xtext.common.Terminals

generate udb "http://www.xtext.org/example/udb/Udb"

import "http://www.eclipse.org/emf/2002/Ecore" as ecore

Model:
	kind += Kind
	csrName += Name
	longname += LongName
	address += Address
	writable += Writable
	privmode += PrivMode
	length += Length
	description += Description
	definedBy += DefinedBy
	base += Base?
	indirectAddress += IndirectAddress?
	indirectSlot += IndirectSlot?
	virtualAddress += VirtualAddress?
	requires += Requires?
	fields += Fields?
	swRead += SwRead?
	source += Source?
	certNormativeRules += CertNormativeRules?
	certTestProcedures += CertTestProcedures?
	
;

/* Required fields for the CSR schema */
Kind: 'kind' ':' kind=KindType ';';
Name: 'name' ':' name=NameType';';
LongName: 'long_name' ':' long_name=STRING';';
Address: 'address' ':' address=Hex';'; /* need to make this only accept 3 digit hex */
Writable: 'writable' ':' writable=BOOLEAN';';
PrivMode:'priv_mode' ':' priv_mode=PrivType';';
Length: 'length' ':' length=STRING ';'; /* need to change string into an enum (?) */
Description: 'description' ':' description=STRING ';';
DefinedBy:'definedBy' ':'extension_name=ID ';'; /* will need to change this to include valid extensions */

/* Optional fields for the CSR schema */
Base: 'base' ':' base=INT ';';
IndirectAddress:'indirect_address' ':' indirect_address=INT';';
IndirectSlot:'indirect_slot' ':' indirect_slot=INT';';
VirtualAddress:'virtual_address' ':' virtual_address=BOOLEAN ';'; 
Requires:'requires' ':' requires=STRING ';';
SwRead:'sw_read()' ':' sw_read=STRING';';
Source:'$source' ':' source=STRING ';';
CertNormativeRules: 'cert_normative_rules' ':' cert_normative_rules=CNRType ';';
CertTestProcedures: 'cert_test_procedures' ':' cert_test_procedures=CTPType ';';






/* this will need to be an enum once we  
 * expand to include other schemas
 */
KindType:
	type=('csr'|'extension') 
;

NameType:
	type=(CSR_NAME)
;

PrivType:
	priv_type=('U'|'S'|'M') /* may need to turn into an enum */
;

// ask about these two in tuesday meeting
CNRType:
	type=[Entity] (array?='['']')
;
CTPType:
	type=[Entity] (array?='['']')
;
// 
Fields:
	{Fields} 'fields' '{'
    fields+=FIELD_DEF+
  '}'
;

FIELD_DEF:
	name=FIELD_TYPE '{'
		field_location += Location
		field_description += Description
		field_type += Type
		field_alias += Alias
		field_sw_write += SWWrite
		field_reset_value += ResetValue
	'}'
	
;

FIELD_TYPE: 
	('VXRM' | 'VXSAT') /* should be an enum */
;

Location: GeneralLocation | SpecificLocation;
Type: "type" ":" type=STRING ';';
Alias: "alias" ":" alias=STRING ';'; /* not sure what this is supposed to be */
SWWrite: "sw_write(csr_value)" ":" STRING ';'; /* this should be IDL */
ResetValue: "reset_value" ":" STRING ';'; /* should be an enum */

GeneralLocation: 
	"location" ":" location=STRING ';'
;

SpecificLocation:
	location32 += LocationRV32
	location64 += LocationRV64
;

LocationRV32: 
	"location_rv32" ":" location32=STRING ";"
;

LocationRV64:
	"location_rv64" ":" location64=STRING ";"
;

Hex:
	value=HEX_VALUE
;


/* Definitions for different names */
terminal CSR_NAME: ('a'..'z')('a'..'z' | '0'..'9' | '_' | '.')+;
		
/* Terminals */
terminal HEX_VALUE returns ecore::EInt:
	('0x' | '0X')
	('0'..'9' | 'A'..'F' | 'a'..'f')
	(('0'..'9' | 'A'..'F' | 'a'..'f' | '_')*('0'..'9' | 'A'..'F' | 'a'..'f'))?
;

terminal BOOLEAN returns ecore::EBoolean: 'true' | 'false';
