/*
 * generated by Xtext 2.39.0
 */
package org.xtext.example.udb.validation;

import org.eclipse.emf.common.util.EList;
import org.eclipse.xtext.validation.Check;
import org.xtext.example.udb.udb.UdbPackage;
import org.xtext.example.udb.parser.antlr.UdbParser;

import org.xtext.example.udb.udb.Model;
import org.xtext.example.udb.udb.CsrModel;
import org.xtext.example.udb.udb.CsrFieldDef;

import org.xtext.example.udb.udb.IntType;
import org.xtext.example.udb.udb.LengthType;
import org.xtext.example.udb.udb.ParmType;
import org.xtext.example.udb.udb.Url;
import org.xtext.example.udb.udb.Email;

import org.xtext.example.udb.udb.ExtName;
import org.xtext.example.udb.udb.ExtVersionArrayElement;
import org.xtext.example.udb.udb.CsrName;
import org.xtext.example.udb.udb.CsrAliasName;


/**
 * This class contains custom validation rules.
 *
 * See https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#validation
 */
public class UdbValidator extends AbstractUdbValidator {
	
	// Regex's found in schema_defs.json
	String rviVersionRegex = "^[0-9]+(\\.[0-9]+(\\.[0-9]+(-pre)?)?)?$";
	String csrFieldRegex = "^[a-z][a-z0-9_.]+\\.[A-Z0-9]+$";
    String csrFieldBitsRegex = "^[a-z][a-z0-9_.]+\\.[A-Z0-9]+\\[[0-9]+(:[0-9]+)?\\]$";
    String csrNameRegex = "^[a-z][a-z0-9_.]+$";
    String extensionNameRegex = "^(([A-WY])|([SXZ][a-z0-9]+))$";
    
    // Extra regex's for validation
    String urlRegex = "^https?:\\/\\/[^\\s/$.?#].[^\\s]*$";
    String emailRegex = "^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$";

	
    /*
     * CSR Validation -- rules found in csr_schema.json
     */
	@Check
	public void checkAddress(CsrModel csr) {
		// Address must be between 0 and 12 bits
		int address = csr.getAddress() != null ? csr.getAddress().getAddress().getValue() : null;

		if(address < 0 || address > 4096) {
			error("Address must be between 0 and 12 bits.", UdbPackage.Literals.CSR_MODEL__ADDRESS);
		}
	}

	@Check
	public void checkVirtualAddressValue(CsrModel csr) {
		/* Ensure virtual address is in required range 0-4095 */
		int vaddress = csr.getVirtualAddress() != null ?
					   csr.getVirtualAddress().getVirtualAddress().getValue() : null;

		if (vaddress < 0 || vaddress > 4095) {
			error("Virtual address must be between 0 and 12 bits.", UdbPackage.Literals.CSR_MODEL__VIRTUAL_ADDRESS);
		}
	}

	@Check
	public void checkIndirectAddressValue(CsrModel csr) {
		/* Ensure indirect address is in required range */
		int iaddress = csr.getIndirectAddress() != null ?
					   csr.getIndirectAddress().getIndirectAddress().getValue() : null;

		if(iaddress < 0 || iaddress > (2^64)) {
			error("Indirect address must be between 0 and 64 bits.", UdbPackage.Literals.CSR_MODEL__INDIRECT_ADDRESS);
		}
	}

	@Check
	public void checkBaseValue(CsrModel csr) {
		/* Ensure base value is either 32 or 64 */
		int base = csr.getBase() != null ?csr.getBase().getBase() : null;

		if (base != 32 && base != 64) {
			error("Base must have value of 32 or 64.", UdbPackage.Literals.CSR_MODEL__BASE);
		}
	}

	@Check
	public void checkLengthValue(CsrModel csr) {
		// Containment reference is always instantiated
		LengthType length_t = csr.getLength().getLength();
		if (length_t == null) {
			error("length should not be null",
					UdbPackage.Literals.CSR_MODEL__LENGTH);
		}
		// If length is an integer, value is either 32 or 64
		if (length_t instanceof IntType) {
			Integer length = ((IntType) csr.getLength().getLength()).getIntVal();
			if (length != 32 && length != 64) {
				error("length if specified as integer, should be 32 or 64",
						UdbPackage.Literals.CSR_MODEL__LENGTH);
			}
		}
//		if (length != null && length != "MXLEN" && length != "SXLEN" && length != "VSXLEN" && length != "XLEN") {
//			if (Integer.valueOf(length) != 32 && Integer.valueOf(length) != 64) {
//			error("Integer length value must be 32 or 64.", UdbPackage.Literals.MODEL__LENGTH);
//			}
//		}

	}

	@Check
	public void checkIndirectSlotValue(CsrModel csr) {
		/* Ensure indirect_slot is between 1 and 6 */
		int slot = csr.getIndirectSlot() != null ? csr.getIndirectSlot().getIndirectSlot() : null;

		if (slot < 1 || slot > 6) {
			error("Indirect slot value must be between 1 and 6.", UdbPackage.Literals.CSR_MODEL__INDIRECT_SLOT);
		}
	}

	@Check
	public void checkVirtualAddress(CsrModel csr) {
		String mode = csr.getPrivmode() != null ? csr.getPrivmode().getPrivMode().getType() : null;

		if (mode.equals("VS")) {
			if (csr.getVirtualAddress() == null) {
				error("VS mode requires a virtual address.", UdbPackage.Literals.CSR_MODEL__PRIVMODE);
			}
		}

	}
	
	/*
	 * Checks for different names to make sure they follow the right regex's
	 */
	@Check
	public void checkExtName(ExtName name) {
	    String value = name.getName();
	    if (!value.matches(extensionNameRegex)) {
	        error("Invalid extension name", 
	              UdbPackage.Literals.EXT_NAME__NAME);
	    }
	}
	
	@Check
	public void checkCsrName(CsrName name) {
	    String value = name.getName();
	    if (!value.matches(csrNameRegex)) {
	        error("Invalid csr name", 
	              UdbPackage.Literals.CSR_NAME__NAME);
	    }
	}
	
	@Check
	public void checkCsrFieldName(CsrFieldDef field) {
		String value = field.getName();
		if (!value.matches("^[a-zA-Z].*$")) {
			error("Invalid field name",
					UdbPackage.Literals.CSR_FIELD_DEF__NAME);
		}
	}
	
	@Check
	public void checkCsrFieldAlias(CsrAliasName alias) {
		String value = alias.getName();

	    if (!value.matches(csrFieldRegex) &&
	        !value.matches(csrFieldBitsRegex)) {

	        error(
	            "Alias must match CSR_FIELD or CSR_FIELD_BITS format",
	            UdbPackage.Literals.CSR_ALIAS_NAME__NAME
	        );
	    }
	}
	
	@Check
	public void checkExtensionVersion(ExtVersionArrayElement element) {
		String version = element.getVersion();
		if (!version.matches(rviVersionRegex)) {
			error("Invalid version", UdbPackage.Literals.EXT_VERSION_ARRAY_ELEMENT__VERSION);
		}
	}
	
	@Check
	public void checkUrlFormat(Url url) {
		// Check that URLs follow the URI format
		String urlString = url.getUrl();
		if (!urlString.matches(urlRegex)) {
			error("URL not in URI format", UdbPackage.Literals.URL__URL);
		}
	}
	
	@Check
	public void checkEmailFormat(Email email) {
		// Check that emails follow email format
		String emailString = email.getEmail();
		if (!emailString.matches(emailRegex)) {
			error("Email not in formatted correctly", UdbPackage.Literals.EMAIL__EMAIL);
		}
	}

}
