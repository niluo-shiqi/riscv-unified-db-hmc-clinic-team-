# Copyright (c) Qualcomm Technologies, Inc. and/or its subsidiaries.
# SPDX-License-Identifier: BSD-3-Clause-Clear

# yaml-language-server: $schema=tests-schema.json

---
tests:
  regress-idlc-unit:
    ci_stage: pr
    tags:
      - unit
      - smoke
    test:
      - name: Run idlc unit tests
        run: ./do test:idlc:unit
    gh_post:
      - name: Upload idlc coverage reports to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          disable_search: true
          files: tools/ruby-gems/idlc/coverage/coverage.xml
          flags: idlc

  regress-udb-helpers-unit:
    ci_stage: pr
    tags:
      - unit
      - smoke
    test:
      - name: Run udb-helpers unit tests
        run: ./do test:udb_helpers:unit

  regress-sorbet:
    ci_stage: pr
    tags:
      - smoke
    test:
      - name: Run sorbet checks
        run: export XDG_CACHE_HOME=${{ github.workspace }}/.cache && ./do test:sorbet

  regress-ext-explorer:
    ci_stage: pr
    test:
      - name: Generate ISA Explorer browser artifacts
        run: ./bin/udb-gen isa-explorer -t ext-browser -o gen/isa_explorer --skip 6

  regress-idl-typecheck:
    ci_stage: pr
    tags:
      - smoke
    test:
      - name: Type check IDL for _
        run: ./do test:idl CFG=_
      - name: Type check IDL for rv32
        run: ./do test:idl CFG=rv32
      - name: Type check IDL for rv64
        run: ./do test:idl CFG=rv64
      - name: Type check IDL for qc_iu
        run: ./do test:idl CFG=qc_iu

  regress-test-inst-encodings:
    ci_stage: pr
    tags:
      - smoke
    test:
      - name: Checking for conflicts in instruction encodings
        run: ./do test:inst_encodings

  regress-gen-isa-manual:
    ci_stage: pr
    gh_pre:
      - name: checkout ISA manual
        run: git submodule update --init ext/riscv-isa-manual
      - name: Mark isa-manual as safe
        # Run in docker to get git config set correctly for submodules
        run: ./bin/bash -c "git config --local --add safe.directory '*'"
    test:
      - name: Generate HTML ISA manual
        run: ./bin/generate manual -c regress -v isa_regress -f html

  regress-gen-instruction-appendix:
    ci_stage: pr
    test:
      - name: Generate instruction appendix asciidoc
        run: ./do gen:instruction_appendix_adoc
      - name: Check instruction appendix result
        run: ./do test:instruction_appendix

  regress-cfg-manual:
    ci_stage: pr
    test:
      - name: Generate HTML ISA manual
        run: ./do gen:html[example_rv64_with_overlay]

  regress-gen-ext-pdf:
    ci_stage: pr
    test:
      - name: Generate Xqci extension PDF
        run: ./bin/ruby tools/scripts/gen_xqci.rb

  regress-gen-certificate:
    ci_stage: pr
    test:
      - name: Generate extension PDF
        run: ./do gen:proc_crd_pdf[MockProcessor]

  regress-gen-profile:
    ci_stage: pr
    test:
      - name: Generate extension PDF
        run: ./do gen:profile_release_pdf[Mock]

  regress-udb-unit-test:
    ci_stage: pr
    tags:
      - unit
    strategy:
      matrix:
        test:
          - logic
          - conditions
          - cli
          - yaml_loader
          - cfg_arch
          - cfg
          - z3
          - mmr
          - mmr_schema
    test:
      - name: Run udb gem ${{ matrix.test }} unit tests
        run: ./bin/ruby tools/ruby-gems/udb/test/test_${{ matrix.test }}.rb
    gh_post:
      - name: Update ownership of coverage files # TODO: Remove when Docker image uses non-root user
        run: sudo chown -R $USER:$USER tools/ruby-gems/udb/coverage
      - name: Rename coverage file
        run: mv tools/ruby-gems/udb/coverage/.resultset.json tools/ruby-gems/udb/coverage/${{ matrix.test }}.resultset.json
      - name: Save coverage report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: udb-${{ matrix.test }}-cov
          path: tools/ruby-gems/udb/coverage/${{ matrix.test }}.resultset.json

  regress-gen-go:
    ci_stage: pr
    test:
      - name: Generate Go code
        run: ./do gen:go

  regress-gen-c-header:
    ci_stage: pr
    test:
      - name: Generate c_header code
        run: ./do gen:c_header

  regress-gen-sverilog:
    ci_stage: pr
    test:
      - name: Generate sverilog_header code
        run: ./do gen:sverilog

  regress-cpp-unit:
    ci_stage: pr
    tags:
      - unit
    test:
      - name: Run cpp unit tests
        run: ./do test:cpp_hart CONFIG=rv64 JOBS=4 BUILD_TYPE=debug

  regress-riscv-tests-32:
    ci_stage: pr
    gh_pre:
      - name: check out riscv-tests
        run: git submodule update --init ext/riscv-tests
    test:
      - name: Run RV32 riscv-tests
        run: ./do test:riscv_tests CONFIG=rv32 IGNOREUNDEFINED=YES JOBS=4 BUILD_TYPE=debug

  regress-riscv-tests-64:
    ci_stage: pr
    gh_pre:
      - name: check out riscv-tests
        run: git submodule update --init ext/riscv-tests
    test:
      - name: Run RV64 riscv-tests
        run: ./do test:riscv_tests CONFIG=rv64 IGNOREUNDEFINED=YES JOBS=4 BUILD_TYPE=debug

  regress-xqci-doc:
    ci_stage: pr
    test:
      - name: Generate Xqci pdf documentation
        run: ./bin/ruby tools/scripts/gen_xqci.rb

  regress-profile-extensions:
    ci_stage: pr
    test:
      - name: Check profile_extensions
        run: ./do test:profile_extensions

  regress-regress:
    ci_stage: pr
    test:
      - name: Test that local regress runner works
        run: ./bin/regress -n regress-sorbet

  build-reuse-manifest:
    ci_stage: merge_queue
    gh_save_artifact:
      - artifact_name: reuse-manifest
        path: reuse_bom.txt
    tags: [artifacts]
    test:
      - name: Create reuse manifest
        run: ./bin/reuse spdx -o reuse_bom.txt

  build-udb-api-docs:
    ci_stage: merge_queue
    gh_save_artifact:
      - artifact_name: udb-api
        path: gen/udb_api_doc
        include-hidden-files: true
    tags: [artifacts]
    test:
      - name: Generate UDB API Docs
        run: ./do gen:udb:api_doc

  resolve-unconfig:
    ci_stage: merge_queue
    gh_save_artifact:
      - artifact_name: resolved-spec
        path: gen/resolved_spec/_
        include-hidden-files: true
    tags: [artifacts]
    test:
      - name: Resolve Unconfig with IDL AST
        run: ./do gen:resolved_arch COMPILE_IDL=1
      - name: Tar unconfig
        run: tar czf gen/resolved_spec/_resolved_spec.tar.gz gen/resolved_spec/_ && mv gen/resolved_spec/_resolved_spec.tar.gz gen/resolved_spec/_/resolved_spec.tar.gz

  build-isa-explorer-csr:
    ci_stage: merge_queue
    gh_save_artifact:
      - artifact_name: isa-explorer-csr
        path: gen/isa_explorer/browser
    tags: [artifacts]
    test:
      - name: Generate ISA Explorer CSR
        run: ./bin/udb-gen isa-explorer -t csr-browser -o gen/isa_explorer/browser

  build-isa-explorer-ext:
    ci_stage: merge_queue
    gh_save_artifact:
      - artifact_name: isa-explorer-ext
        path: gen/isa_explorer/browser
    tags: [artifacts]
    test:
      - name: Generate ISA Explorer Extension
        run: ./bin/udb-gen isa-explorer -t ext-browser -o gen/isa_explorer/browser

  build-isa-explorer-inst:
    ci_stage: merge_queue
    gh_save_artifact:
      - artifact_name: isa-explorer-inst
        path: gen/isa_explorer/browser
    tags: [artifacts]
    test:
      - name: Generate ISA Explorer Instruction
        run: ./bin/udb-gen isa-explorer -t inst-browser -o gen/isa_explorer/browser

  build-isa-explorer-spreadsheet:
    ci_stage: merge_queue
    gh_save_artifact:
      - artifact_name: isa-explorer-spreadsheet
        path: gen/isa_explorer/spreadsheet
    test:
      - name: Generate ISA Explorer Spreadsheet
        run: ./bin/udb-gen isa-explorer -t xlsx -o gen/isa_explorer/spreadsheet

  build-html-isa-manual:
    ci_stage: merge_queue
    gh_save_artifact:
      - artifact_name: isa-html-manual
        path: gen/manual/isa/top/all/html
    tags: [artifacts]
    test:
      - name: Generate HTML ISA manual
        run: ./bin/generate manual -v all -f html

  build-html-cfg-isa-manual:
    ci_stage: merge_queue
    gh_save_artifact:
      - artifact_name: cfg-html-manual
        path: gen/cfg_html_doc/example_rv64_with_overlay/html
    tags: [artifacts]
    test:
      - name: Generate HTML ISA manual for a config
        run: ./do gen:html[example_rv64_with_overlay]

  build-instruction-appendix:
    ci_stage: merge_queue
    gh_save_artifact:
      - artifact_name: inst-appendix
        path: gen/instructions_appendix/instructions_appendix.pdf
    gh_pre:
      - name: checkout docs resources
        run: git submodule update --init ext/docs-resources
    tags: [artifacts]
    test:
      - name: Generate instruction appendix
        run: ./do gen:instruction_appendix

  build-profile:
    ci_stage: merge_queue
    gh_save_artifact:
      - artifact_name: ${{ matrix.profile }}
        path: gen/profile/pdf/RVA20ProfileRelease.pdf
    strategy:
      matrix:
        profile:
          - rvi20
          - rva20
          - rva22
          - rva23
          - rvb23
    tags: [artifacts]
    test:
      - name: Generate ${{ matrix.profile }}
        run: |
          PROFILE_NAME="${{ matrix.profile }}"
          UPPER_PROFILE="${PROFILE_NAME^^}"
          ./do gen:profile_release_pdf[${PROFILE_NAME}]

  build-idl-doc:
    ci_stage: merge_queue
    gh_save_artifact:
      - artifact_name: idl-doc
        path: idl.html
    tags: [artifacts]
    test:
      - name: Build IDL doc
        run: ./bin/bundle exec asciidoctor -r idl_highlighter -a toc=left -a source-highlighter=rouge -o idl.html doc/idl.adoc
