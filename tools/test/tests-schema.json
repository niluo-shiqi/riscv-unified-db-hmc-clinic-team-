{
  "$schema": "http://json-schema.org/draft-07/schema#",

  "title": "Schema for test definitions",

  "type": "object",

  "additionalProperties": false,
  "required": ["tests"],

  "properties": {
    "tests": {
      "description": "Mapping of tests. Keys are the test names, and values are the test data",
      "type": "object",
      "examples": [
        {
          "description": "Run a simple regression that must pass before a PR can merge",
          "ci_stage": "pr",
          "test": [
            {
              "name": "Say hello",
              "run": "echo 'hello world'"
            }
          ]
        },
        {
          "description": "Run a task that must pass after a PR is in the merge queue, but before it merges with main",
          "ci_stage": "merge_queue",
          "test": [
            {
              "name": "Say hello, and remember it",
              "run": "echo 'hello world' > saved_artifact"
            }
          ],
          "gh_save_artifact": [
            {
              "artifact_name": "a-name",
              "path": "saved_artifact"
            }
          ]
        }
      ],
      "patternProperties": {
        ".*": {
          "description": "A regression test definition",
          "type": "object",
          "additionalProperties": false,
          "required": ["test", "ci_stage"],
          "properties": {
            "test": {
              "description": "The main test, specified as a series of shell commands.\n Borrows the {name, run} syntax from GitHub Actions",
              "examples": [
                {
                  "test": [
                    {
                      "name": "Say Hello",
                      "run": "echo \"Hello\""
                    }
                  ]
                },
                {
                  "test": [
                    {
                      "name": "Test Foo",
                      "run": "./do test:foo"
                    },
                    {
                      "name": "Test Bar",
                      "run": "./do test:bar"
                    }
                  ]
                }
              ],
              "type": "array",
              "items": {
                "type": "object",
                "required": ["name", "run"],
                "additionalProperties": false,
                "properties": {
                  "name": { "type": "string" },
                  "run": { "type": "string" },
                  "env": {
                    "type": "object",
                    "patternProperties": {
                      ".*": { "type": "string" }
                    }
                  }
                }
              }
            },
            "tags": {
              "description": "A list of tags associated with the test",
              "examples": ["smoke", "unit"],
              "type": "array",
              "items": { "type": "string" }
            },
            "ci_stage": {
              "enum": ["pr", "merge_queue"]
            },
            "gh_save_artifact": {
              "description": "Use this if something from the test should be saved for a later action.\nThe upload *only* occurs when the test is being run on a `push` event to main.\nWhen used, the file or folder at `path` will be uploaded to github after all test steps complete.\n\nThis is typically used to save an artifact to display on the pages deployment.",
              "type": "array",
              "items": {
                "type": "object",
                "required": ["artifact_name", "path"],
                "properties": {
                  "artifact_name": {
                    "description": "Artifact name, passed to actions/upload-artifact",
                    "type": "string"
                  },
                  "path": {
                    "description": "Artifact path, passed to actions/upload-artifact",
                    "type": "string"
                  },
                  "include-hidden-files": {
                    "description": "When the artifact is a directory, should hidden files be included?",
                    "type": "boolean",
                    "default": false
                  }
                },
                "additionalProperties": false
              },
              "minItems": 1
            },
            "env": {
              "description": "Environment variables set for the test",
              "examples": [
                {
                  "env": { "VAR1": "value1" }
                },
                {
                  "env": { "VAR2": "value2", "VAR3": "value3" }
                }
              ],
              "type": "object",
              "patternProperties": {
                ".*": { "type": "string" }
              }
            },
            "strategy": {
              "description": "strategy, as defined by GitHub workflow syntax. Used to turn a test spec into  template over many values",
              "examples": [
                {
                  "strategy": {
                    "matrix": {
                      "subtest": ["t1", "t2"]
                    }
                  }
                }
              ],
              "type": "object",
              "required": ["matrix"],
              "additionalProperties": false,
              "properties": {
                "matrix": {
                  "type": "object",
                  "patternProperties": {
                    ".*": {
                      "type": "array",
                      "items": { "type": "string" }
                    }
                  }
                }
              }
            },
            "gh_post": {
              "description": "Steps to run in GitHub CI after the main test is done. These steps are not executed by ./bin/regress",
              "type": "array",
              "items": {
                "type": "object"
              }
            },
            "gh_pre": {
              "description": "Steps to run in GitHub CI before the main test runs. These steps are not executed by ./bin/regress.",
              "type": "array",
              "items": {
                "type": "object"
              }
            }
          }
        }
      }
    }
  }
}
